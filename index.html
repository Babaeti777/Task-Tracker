<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Eisenhower Matrix - AI Task Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .quadrant-1-border { border-color: #ef4444 !important; }
        .quadrant-2-border { border-color: #3b82f6 !important; }
        .quadrant-3-border { border-color: #f97316 !important; }
        .quadrant-4-border { border-color: #6b7280 !important; }
        .quadrant-1-text { color: #ef4444 !important; }
        .quadrant-2-text { color: #3b82f6 !important; }
        .quadrant-3-text { color: #f97316 !important; }
        .quadrant-4-text { color: #6b7280 !important; }
        .quadrant-1-bg { background-color: #ef4444 !important; }
        .quadrant-2-bg { background-color: #3b82f6 !important; }
        .quadrant-3-bg { background-color: #f97316 !important; }
        .quadrant-4-bg { background-color: #6b7280 !important; }
        .task.overdue { background-color: #fef2f2; border-left-color: #ef4444; }
        .task.running { box-shadow: 0 0 0 2px #3b82f6; background-color: #dbeafe; }
        .drag-over { transform: scale(1.02); background-color: #eff6ff; }
        .task.dragging { opacity: 0.5; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .task-title-input { width: 100%; padding: 2px; border-radius: 4px; border: 1px solid #cbd5e1; outline: none; font-weight: 600; }
        .task-title-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        .spinner { border-top-color: #ffffff; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .task .task-actions { visibility: hidden; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .task:hover .task-actions { visibility: visible; opacity: 1; }
        .task-btn { font-size: 1.1rem; line-height: 1; }
        .task.completed { background-color: #f8f9fa; opacity: 0.6; }
        .task.completed .task-title-text { text-decoration: line-through; }
        #timer-fullscreen { transition: opacity 0.5s ease-in-out; background: linear-gradient(145deg, #444, #222); }
        #timer-fullscreen-display { font-size: clamp(4rem, 25vw, 12rem); font-variant-numeric: tabular-nums; text-shadow: 0 0 20px rgba(255, 255, 255, 0.2); }
        .pulse-animation { animation: pulse 4s ease-in-out infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.7; } 50% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(1); opacity: 0.7; } }
        #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 100; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; width: 320px; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); opacity: 0; transform: translateX(100%); animation: slideIn 0.3s ease-out forwards, fadeOut 0.3s ease-in 4.7s forwards; }
        .toast-success { background-color: #ecfdf5; border: 1px solid #bbf7d0; color: #065f46; }
        .toast-error { background-color: #fef2f2; border: 1px solid #fecaca; color: #991b1b; }
        .toast-info { background-color: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; }
        .toast-icon { margin-right: 0.75rem; font-size: 1.25rem; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-200">

    <div id="configWarning" class="hidden fixed top-0 left-0 right-0 z-[101] px-4 py-3 text-sm font-medium text-center text-red-800 bg-red-100 border-b-2 border-red-200"></div>
    <div id="auth-overlay" class="fixed inset-0 z-[99] flex flex-col items-center justify-center gap-4 bg-gray-100/90 backdrop-blur-sm">
        <div class="w-12 h-12 border-4 border-blue-500 rounded-full border-t-transparent animate-spin"></div>
        <p class="text-lg font-semibold text-gray-700">Initializing...</p>
    </div>

    <header class="fixed top-0 left-0 right-0 z-40 flex items-center justify-between h-16 px-4 bg-white shadow-md sm:px-6 lg:px-8">
        <h1 class="text-2xl font-bold tracking-tight text-gray-800">Eisenhower</h1>
        <div class="flex items-center gap-4">
            <button id="completedToggleBtn" data-action="toggle-completed-panel" class="flex items-center gap-2 px-3 py-2 text-sm font-semibold text-gray-700 transition bg-gray-200 rounded-lg hover:bg-gray-300">
                <span>üóÉÔ∏è</span>
                <span class="hidden sm:inline">Completed</span>
                <span id="completedCountBadge" class="hidden px-2 py-0.5 text-xs font-bold text-white bg-blue-600 rounded-full">0</span>
            </button>
            <button id="openSettingsBtn" data-action="open-settings" class="flex items-center gap-2 px-3 py-2 text-sm font-semibold text-gray-700 transition bg-gray-200 rounded-lg hover:bg-gray-300">
                <span>‚öôÔ∏è</span>
                <span class="hidden sm:inline">AI Settings</span>
            </button>
            <div id="authSection" class="min-h-[40px]">
                <!-- This will be filled by JavaScript -->
            </div>
        </div>
    </header>

    <main id="main-content" class="pt-24 pb-24">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:gap-8">
                <div class="quadrant quadrant-1 bg-white border-t-4 border-gray-200 rounded-2xl shadow-lg" data-quadrant="1">
                    <div class="flex items-center justify-between p-4 border-b border-gray-200"><h3 class="text-lg font-bold quadrant-1-text">üî• Urgent & Important (Do)</h3><div id="count-1" class="px-3 py-1 text-sm font-bold text-white rounded-full quadrant-1-bg">0</div></div><div id="tasks-1" class="min-h-[200px] p-4 space-y-3"></div>
                </div>
                <div class="quadrant quadrant-2 bg-white border-t-4 border-gray-200 rounded-2xl shadow-lg" data-quadrant="2">
                    <div class="flex items-center justify-between p-4 border-b border-gray-200"><h3 class="text-lg font-bold quadrant-2-text">üìÖ Important (Schedule)</h3><div id="count-2" class="px-3 py-1 text-sm font-bold text-white rounded-full quadrant-2-bg">0</div></div><div id="tasks-2" class="min-h-[200px] p-4 space-y-3"></div>
                </div>
                <div class="quadrant quadrant-3 bg-white border-t-4 border-gray-200 rounded-2xl shadow-lg" data-quadrant="3">
                    <div class="flex items-center justify-between p-4 border-b border-gray-200"><h3 class="text-lg font-bold quadrant-3-text">‚ö° Urgent (Delegate)</h3><div id="count-3" class="px-3 py-1 text-sm font-bold text-white rounded-full quadrant-3-bg">0</div></div><div id="tasks-3" class="min-h-[200px] p-4 space-y-3"></div>
                </div>
                <div class="quadrant quadrant-4 bg-white border-t-4 border-gray-200 rounded-2xl shadow-lg" data-quadrant="4">
                    <div class="flex items-center justify-between p-4 border-b border-gray-200"><h3 class="text-lg font-bold quadrant-4-text">üóëÔ∏è Neither (Eliminate)</h3><div id="count-4" class="px-3 py-1 text-sm font-bold text-white rounded-full quadrant-4-bg">0</div></div><div id="tasks-4" class="min-h-[200px] p-4 space-y-3"></div>
                </div>
            </div>
        </div>
    </main>
    
    <button id="openAddModalBtn" data-action="open-add-modal" title="Add New Task" class="fixed z-40 flex items-center justify-center w-16 h-16 text-3xl font-light text-white bg-blue-600 rounded-full shadow-lg bottom-6 right-6 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        +
    </button>

    <!-- Modals (Timer, Add, Details, Delete, Settings) -->
    <div id="timer-fullscreen" class="fixed inset-0 z-50 flex-col items-center justify-center hidden text-white opacity-0">
        <div class="text-center pulse-animation">
            <h2 id="timer-fullscreen-task-title" class="mb-4 text-4xl font-semibold opacity-80"></h2>
            <div id="timer-fullscreen-display" class="font-bold">25:00</div>
        </div>
        <div class="absolute flex gap-4 bottom-10">
            <button id="timer-fullscreen-pause" class="px-6 py-3 font-semibold text-white bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30">Pause</button>
            <button id="timer-fullscreen-start" class="hidden px-6 py-3 font-semibold text-white bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30">Resume</button>
            <button id="timer-fullscreen-stop" class="px-6 py-3 font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600">Stop & Exit</button>
        </div>
    </div>
    
    <div id="addTaskModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 transition-opacity duration-300 bg-black bg-opacity-50 opacity-0 pointer-events-none modal">
        <div class="w-full max-w-lg p-6 bg-white modal-content rounded-2xl shadow-2xl scale-95 transform-gpu transition-transform duration-300">
            <div class="flex items-center justify-between pb-3 border-b border-gray-200">
                <h3 class="text-2xl font-bold text-gray-800">Add a New Task</h3>
                <button data-action="close-modal" class="p-1 text-gray-400 rounded-full hover:bg-gray-200 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="addTaskForm" class="mt-4">
                <div class="mb-4">
                    <label for="taskTitle" class="text-sm font-medium text-gray-600">Task Title</label>
                    <input type="text" id="taskTitle" placeholder="e.g., Finish project proposal" class="w-full px-4 py-2 mt-1 text-gray-800 bg-gray-100 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                    <div>
                        <label for="taskQuadrant" class="text-sm font-medium text-gray-600">Priority</label>
                        <select id="taskQuadrant" class="w-full px-4 py-2 mt-1 text-gray-800 bg-gray-100 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="1">üî• Urgent & Important</option>
                            <option value="2" selected>üìÖ Important</option>
                            <option value="3">‚ö° Urgent</option>
                            <option value="4">üóëÔ∏è Eliminate</option>
                        </select>
                    </div>
                    <div>
                        <label for="taskTime" class="text-sm font-medium text-gray-600">Est. Minutes</label>
                        <input type="number" id="taskTime" value="25" min="5" class="w-full px-4 py-2 mt-1 text-gray-800 bg-gray-100 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="taskDueDate" class="text-sm font-medium text-gray-600">Due Date</label>
                        <input type="date" id="taskDueDate" class="w-full px-4 py-2 mt-1 text-gray-800 bg-gray-100 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" data-action="close-modal" class="px-6 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="w-full sm:w-auto px-6 py-3 font-semibold text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <div id="detailsModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 transition-opacity duration-300 bg-black bg-opacity-50 opacity-0 pointer-events-none modal">
        <div class="w-full max-w-lg p-6 bg-white modal-content rounded-2xl shadow-2xl scale-95 transform-gpu transition-transform duration-300">
            <div class="flex items-center justify-between pb-3 border-b border-gray-200">
                <h3 id="detailsTitle" class="text-2xl font-bold text-gray-800">Task Details</h3>
                <button data-action="close-modal" class="p-1 text-gray-400 rounded-full hover:bg-gray-200 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="mt-4 space-y-6 max-h-[70vh] overflow-y-auto pr-2">
                <div class="space-y-4">
                    <div>
                        <label for="detailTitleInput" class="text-sm font-medium text-gray-600">Task Title</label>
                        <input id="detailTitleInput" type="text" class="w-full px-3 py-2 mt-1 bg-gray-100 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Update the task title">
                    </div>
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                        <div>
                            <label for="detailQuadrantSelect" class="text-sm font-medium text-gray-600">Priority</label>
                            <select id="detailQuadrantSelect" class="w-full px-3 py-2 mt-1 bg-gray-100 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                <option value="1">üî• Urgent & Important</option>
                                <option value="2">üìÖ Important</option>
                                <option value="3">‚ö° Urgent</option>
                                <option value="4">üóëÔ∏è Eliminate</option>
                            </select>
                        </div>
                        <div>
                            <label for="detailTimeInput" class="text-sm font-medium text-gray-600">Est. Minutes</label>
                            <input id="detailTimeInput" type="number" min="5" class="w-full px-3 py-2 mt-1 bg-gray-100 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="detailDueDateInput" class="text-sm font-medium text-gray-600">Due Date</label>
                            <input id="detailDueDateInput" type="date" class="w-full px-3 py-2 mt-1 bg-gray-100 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-600">
                        <input id="detailCompletedCheckbox" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                        Mark as completed
                    </label>
                    <div class="flex justify-end">
                        <button data-action="save-details" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-md shadow hover:bg-blue-700">
                            <span>üíæ Save Changes</span>
                        </button>
                    </div>
                </div>
                <div class="pt-4 border-t border-gray-200">
                    <div class="flex items-center justify-between">
                        <h4 class="font-semibold text-gray-700">Sub-tasks</h4>
                        <button id="generateSubtasksBtn" data-action="gen-subtasks" class="flex items-center gap-1 px-2 py-1 text-xs font-semibold text-white bg-purple-500 rounded-md hover:bg-purple-600">
                            <span class="btn-text">‚ú® Smart Sub-tasks</span>
                            <div class="hidden w-4 h-4 border-2 border-t-transparent border-white rounded-full spinner"></div>
                        </button>
                    </div>
                    <div id="subtasksContainer" class="mt-2 space-y-2"></div>
                    <div class="flex gap-2 mt-2">
                        <input type="text" id="newSubtaskInput" placeholder="Add a new sub-task..." class="flex-grow px-3 py-1 bg-gray-100 border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <button data-action="add-subtask" class="px-3 py-1 font-semibold text-white bg-blue-500 rounded-md hover:bg-blue-600">Add</button>
                    </div>
                </div>
                <div class="pt-4 border-t border-gray-200">
                     <div class="flex items-center justify-between">
                        <h4 class="font-semibold text-gray-700">Notes</h4>
                        <button id="generateNotesBtn" data-action="gen-notes" class="flex items-center gap-1 px-2 py-1 text-xs font-semibold text-white bg-purple-500 rounded-md hover:bg-purple-600">
                             <span class="btn-text">‚ú® Generate Notes</span>
                             <div class="hidden w-4 h-4 border-2 border-t-transparent border-white rounded-full spinner"></div>
                        </button>
                    </div>
                    <textarea id="taskNotes" rows="4" class="w-full p-2 mt-2 bg-gray-100 border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Add any notes here..."></textarea>
                </div>
            </div>
             <div class="flex justify-end mt-6">
                <button data-action="close-modal" class="px-6 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
             </div>
        </div>
    </div>
    
    <div id="deleteModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 transition-opacity duration-300 bg-black bg-opacity-50 opacity-0 pointer-events-none modal">
        <div class="w-full max-w-sm p-6 bg-white modal-content rounded-2xl shadow-2xl scale-95 transform-gpu transition-transform duration-300">
            <h3 class="text-lg font-semibold text-gray-900">Delete Task</h3>
            <p class="mt-2 text-sm text-gray-600">Are you sure you want to delete this task? This action cannot be undone.</p>
            <div class="flex justify-end gap-3 mt-6">
                <button data-action="close-modal" class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                    Cancel
                </button>
                <button id="confirmDeleteBtn" data-action="confirm-delete" class="px-4 py-2 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">
                    Delete
                </button>
            </div>
        </div>
    </div>
    
    <div id="settingsModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 transition-opacity duration-300 bg-black bg-opacity-50 opacity-0 pointer-events-none modal">
        <div class="w-full max-w-md p-6 bg-white modal-content rounded-2xl shadow-2xl scale-95 transform-gpu transition-transform duration-300">
            <div class="flex items-center justify-between pb-3 border-b border-gray-200">
                <h3 class="text-2xl font-bold text-gray-800">AI Settings</h3>
                <button data-action="close-modal" class="p-1 text-gray-400 rounded-full hover:bg-gray-200 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="mt-4 space-y-4">
                <div>
                    <label for="geminiApiKeyInput" class="text-sm font-medium text-gray-600">Gemini API Key</label>
                    <input type="password" id="geminiApiKeyInput" placeholder="Enter your Google AI Studio API Key" class="w-full px-4 py-2 mt-1 text-gray-800 bg-gray-100 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <p class="mt-1 text-xs text-gray-500">Your key is saved securely in your browser's local storage.</p>
                </div>
            </div>
             <div class="flex justify-end gap-3 mt-6">
                <button data-action="close-modal" class="px-6 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                <button data-action="save-api-key" class="px-6 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Save</button>
             </div>
        </div>
    </div>
    
    <div id="completedOverlay" class="fixed inset-0 z-50 flex justify-end bg-black/30 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="flex-1" data-action="close-completed-panel"></div>
        <aside id="completedPanel" class="relative flex flex-col w-full max-w-md h-full bg-white shadow-2xl transform translate-x-full transition-transform duration-300">
            <div class="flex items-center justify-between px-5 py-4 border-b border-gray-200">
                <div class="flex items-center gap-2 text-lg font-semibold text-gray-800">
                    <span>üóÉÔ∏è</span>
                    <span>Completed Tasks</span>
                </div>
                <button data-action="close-completed-panel" class="p-1 text-gray-400 rounded-full hover:bg-gray-200 hover:text-gray-600">‚úñÔ∏è</button>
            </div>
            <div class="flex-1 overflow-y-auto">
                <div id="completedTasksList" class="p-4 space-y-3"></div>
            </div>
        </aside>
    </div>

    <div id="toast-container"></div>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // --- NEW AUTH IMPORTS ---
        import { 
            getAuth, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // --- END NEW AUTH IMPORTS ---
        import { 
            getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, 
            onSnapshot, collection, query, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE --- //
        // (Copied from your Firebase project's "Web App" settings)
        // ‚¨áÔ∏è PASTE YOUR CONFIG OBJECT HERE ‚¨áÔ∏è
        const USER_PROVIDED_FIREBASE_CONFIG = {
  apiKey: "AIzaSyCkykWc8jK3CONSL0TddJj3J8fFYie17lE",
  authDomain: "task-1c051.firebaseapp.com",
  projectId: "task-1c051",
  storageBucket: "task-1c051.firebasestorage.app",
  messagingSenderId: "574407276539",
  appId: "1:574407276539:web:f524f9e663421c6255bd5e",
  measurementId: "G-KDR87DQGVQ"
}; 
        
        // --- GEMINI API KEY (Can be set in UI) --- //
        let GEMINI_API_KEY = "";

        // --- UTILITY FUNCTIONS --- //
        const escapeHtml = (text) => {
            if (text == null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        };
        
        // --- FIREBASE SERVICE --- //
        const FirebaseService = {
            db: null,
            auth: null,
            userId: null,
            appId: 'default-app-id',
            tasksCollectionRef: null,
            tasksUnsubscribe: null,

            async init(onAuthReady, onSignedOut) {
                let firebaseConfig;
                if (USER_PROVIDED_FIREBASE_CONFIG) {
                    firebaseConfig = USER_PROVIDED_FIREBASE_CONFIG;
                }
                else if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    firebaseConfig = JSON.parse(__firebase_config);
                } 
                else {
                    console.error("Firebase config is missing.");
                    UI.showConfigWarning("<strong>Critical Error:</strong> Firebase configuration is missing. Add your `firebaseConfig` object to the script to fix this.");
                    document.getElementById('auth-overlay')?.classList.add('hidden');
                    return;
                }

                this.appId = typeof __app_id !== 'undefined' ? __app_id : (firebaseConfig.projectId || 'default-app-id');

                try {
                    const app = initializeApp(firebaseConfig);
                    this.db = getFirestore(app);
                    this.auth = getAuth(app);

                    // --- UPDATED AUTH LOGIC ---
                    onAuthStateChanged(this.auth, (user) => {
                        if (user) {
                            // User is signed in
                            this.userId = user.uid;
                            const authSection = document.getElementById('authSection');
                            if (authSection) {
                                // Show user info and Sign Out button
                                authSection.innerHTML = `
                                    <div class="flex items-center gap-3">
                                        <img src="${user.photoURL}" alt="User" class="w-8 h-8 rounded-full">
                                        <span class="text-sm font-medium text-gray-700 hidden sm:inline">${user.displayName || user.email}</span>
                                        <button data-action="sign-out" class="px-3 py-1 text-sm font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Sign Out</button>
                                    </div>`;
                            }
                            
                            const collectionPath = `artifacts/${this.appId}/users/${this.userId}/tasks`;
                            this.tasksCollectionRef = collection(this.db, collectionPath);
                            
                            // Trigger task loading
                            onAuthReady(this.userId);
                            
                        } else {
                            // User is signed out
                            this.userId = null;
                            if (this.tasksUnsubscribe) this.tasksUnsubscribe();
                            this.tasksCollectionRef = null;
                            const authSection = document.getElementById('authSection');
                            if (authSection) {
                                // Show Sign In button
                                authSection.innerHTML = `<button data-action="sign-in-google" class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg shadow hover:bg-blue-700">
                                    Sign In with Google
                                    </button>`;
                            }
                            // Trigger clearing the UI
                            onSignedOut();
                        }
                        // Hide overlay after first auth check, regardless of state
                        document.getElementById('auth-overlay')?.classList.add('hidden');
                    });
                    // --- END UPDATED AUTH LOGIC ---
                    
                } catch (error) {
                    console.error("Firebase initialization error:", error);
                    let errorMsg = `<strong>Firebase Error:</strong> ${error.message}.`;
                    UI.showConfigWarning(errorMsg);
                    document.getElementById('auth-overlay')?.classList.add('hidden');
                }
            },

            // --- NEW: Sign In with Google ---
            async signInWithGoogle() {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(this.auth, provider);
                    // onAuthStateChanged will handle the successful login
                } catch (error) {
                    console.error("Error signing in with Google:", error);
                    UI.showNotification(`Sign-in failed: ${error.message}`, "error");
                }
            },

            // --- NEW: Sign Out ---
            async signOut() {
                try {
                    await signOut(this.auth);
                    // onAuthStateChanged will handle the successful sign-out
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            },

            getTasksSnapshot(callback) {
                if (!this.tasksCollectionRef) return;
                if (this.tasksUnsubscribe) this.tasksUnsubscribe();

                const q = query(this.tasksCollectionRef);
                this.tasksUnsubscribe = onSnapshot(q, (querySnapshot) => {
                    const tasks = [];
                    querySnapshot.forEach((doc) => {
                        tasks.push({ id: doc.id, ...doc.data() });
                    });
                    tasks.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    callback(tasks);
                }, (error) => {
                    console.error("Error getting tasks snapshot:", error);
                    console.error("Error code:", error.code);
                    console.error("Error message:", error.message);

                    if (error.code === 'permission-denied') {
                        UI.showConfigWarning(`
                            <strong>‚ö†Ô∏è Firestore Permission Denied</strong><br>
                            Your Firestore security rules are blocking access. To fix this:<br>
                            1. Go to <a href="https://console.firebase.google.com/project/task-1c051/firestore/rules" target="_blank" class="underline">Firebase Console ‚Üí Firestore Rules</a><br>
                            2. Update rules to allow authenticated users to access their data<br>
                            3. See <code>FIRESTORE_SETUP.md</code> for detailed instructions
                        `);
                        UI.showNotification("Permission denied - Check banner above for fix", "error");
                    } else {
                        UI.showNotification(`Error syncing tasks: ${error.message}`, "error");
                    }
                });
            },

            async addTask(task) {
                if (!this.tasksCollectionRef) {
                    UI.showNotification("You must be signed in to add tasks.", "error");
                    return;
                }
                try {
                    await addDoc(this.tasksCollectionRef, task);
                } catch (error) {
                    console.error("Error adding task:", error);
                    if (error.code === 'permission-denied') {
                        UI.showNotification("Permission denied - Check Firestore security rules", "error");
                    } else {
                        UI.showNotification(`Failed to add task: ${error.message}`, "error");
                    }
                }
            },

            async updateTask(taskId, taskData) {
                if (!this.tasksCollectionRef) return;
                try {
                    const taskDocRef = doc(this.tasksCollectionRef, taskId);
                    await setDoc(taskDocRef, taskData, { merge: true });
                } catch (error) {
                    console.error("Error updating task:", error);
                    if (error.code === 'permission-denied') {
                        UI.showNotification("Permission denied - Check Firestore security rules", "error");
                    } else {
                        UI.showNotification(`Failed to update task: ${error.message}`, "error");
                    }
                }
            },

            async deleteTask(taskId) {
                if (!this.tasksCollectionRef) return;
                try {
                    const taskDocRef = doc(this.tasksCollectionRef, taskId);
                    await deleteDoc(taskDocRef);
                } catch (error) {
                    console.error("Error deleting task:", error);
                    if (error.code === 'permission-denied') {
                        UI.showNotification("Permission denied - Check Firestore security rules", "error");
                    } else {
                        UI.showNotification(`Failed to delete task: ${error.message}`, "error");
                    }
                }
            }
        };

        // --- GEMINI AI SERVICE --- //
        const GeminiService = {
            init() {
                GEMINI_API_KEY = localStorage.getItem('geminiApiKey') || '';
            },

            saveApiKey() {
                const key = document.getElementById('geminiApiKeyInput').value.trim();
                if (key) {
                    GEMINI_API_KEY = key;
                    localStorage.setItem('geminiApiKey', key);
                    UI.showNotification("API Key saved successfully.", "success");
                    UI.closeModal('settingsModal');
                } else {
                    UI.showNotification("Please enter a valid API Key.", "error");
                }
            },

            setLoadingState(buttonId, isLoading) {
                const button = document.getElementById(buttonId);
                if (button) {
                    const text = button.querySelector('.btn-text');
                    const spinner = button.querySelector('.spinner');
                    if (isLoading) {
                        text.classList.add('hidden');
                        spinner.classList.remove('hidden');
                        button.disabled = true;
                    } else {
                        text.classList.remove('hidden');
                        spinner.classList.add('hidden');
                        button.disabled = false;
                    }
                }
            },

            async call(prompt) {
                if (!FirebaseService.userId) {
                    UI.showNotification("You must be signed in to use AI features.", "error");
                    return null;
                }
                if (!GEMINI_API_KEY) {
                    UI.showNotification("Gemini API Key is not set. Please add it in Settings.", "error");
                    UI.openModal('settingsModal');
                    return null;
                }
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
                
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result.candidates[0].content.parts[0].text;
                    
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    UI.showNotification(`AI Error: ${error.message}`, "error");
                    return null;
                }
            },
            
            async generateSubtasks() {
                this.setLoadingState('generateSubtasksBtn', true);
                const task = TaskManager.tasks.find(t => t.id === UI.currentDetailTaskId);
                if (!task) { this.setLoadingState('generateSubtasksBtn', false); return; }

                const promptText = `Generate a comma-separated list of actionable sub-tasks for the task: "${task.title}". Provide only the list.`;
                const result = await this.call(promptText);
                if (result) {
                    result.split(',').forEach(subtaskText => {
                        if (subtaskText.trim()) {
                            TaskManager.addSubtask(subtaskText.trim(), true);
                        }
                    });
                }
                this.setLoadingState('generateSubtasksBtn', false);
            },
            
            async generateNotes() {
                this.setLoadingState('generateNotesBtn', true);
                const task = TaskManager.tasks.find(t => t.id === UI.currentDetailTaskId);
                if (!task) { this.setLoadingState('generateNotesBtn', false); return; }

                const promptText = `Generate helpful notes for the task: "${task.title}". The notes should be a short paragraph, offering a brief plan or key considerations.`;
                const result = await this.call(promptText);
                if (result) {
                    const notesArea = document.getElementById('taskNotes');
                    notesArea.value = result;
                    TaskManager.updateNotes(result);
                }
                this.setLoadingState('generateNotesBtn', false);
            }
        };

        // --- TIMER --- //
        const Timer = {
            currentTask: null, duration: 0, remaining: 0, interval: null, isRunning: false,
            
            startFromTask(taskId, evt = null) {
                if (evt) evt.stopPropagation();
                if (!FirebaseService.userId) {
                    UI.showNotification("You must be signed in to use the timer.", "error");
                    return;
                }
                const task = TaskManager.tasks.find(t => t.id === taskId);
                if (!task) return;
                
                if (this.currentTask && this.currentTask.id === taskId) {
                    this.isRunning ? this.pause() : this.start();
                } else {
                    if (this.isRunning) {
                        this.stop(true, false);
                    }
                    this.currentTask = task;
                    this.duration = task.timeBox * 60;
                    this.remaining = task.remainingTime || this.duration; 
                    this.showFullscreen();
                    this.start();
                }
            },
            start() {
                if (!this.currentTask || this.isRunning) return;
                this.isRunning = true;
                this.interval = setInterval(() => {
                    this.remaining--;
                    this.updateFullscreenDisplay();
                    if (this.remaining <= 0) {
                        this.stop(false, true); 
                        UI.showNotification(`Time's up for: ${this.currentTask.title}`, 'info');
                        TaskManager.toggleComplete(this.currentTask.id);
                    }
                }, 1000);
                document.getElementById('timer-fullscreen-pause').classList.remove('hidden');
                document.getElementById('timer-fullscreen-start').classList.add('hidden');
            },
            pause() {
                this.isRunning = false;
                clearInterval(this.interval);
                if (this.currentTask) {
                    this.currentTask.remainingTime = this.remaining;
                    TaskManager.updateTask(this.currentTask);
                }
                document.getElementById('timer-fullscreen-pause').classList.add('hidden');
                document.getElementById('timer-fullscreen-start').classList.remove('hidden');
            },
            stop(silent = false, resetTimer = false) {
                this.pause(); 
                if (this.currentTask && resetTimer) {
                    this.currentTask.remainingTime = null;
                    TaskManager.updateTask(this.currentTask);
                }
                this.currentTask = null; this.remaining = 0;
                if (!silent) { this.hideFullscreen(); TaskManager.render(); }
            },
            showFullscreen() {
                 document.getElementById('timer-fullscreen-task-title').textContent = this.currentTask.title;
                 this.updateFullscreenDisplay();
                 const timerScreen = document.getElementById('timer-fullscreen');
                 timerScreen.classList.remove('hidden');
                 setTimeout(() => timerScreen.classList.remove('opacity-0'), 10);
            },
            hideFullscreen() {
                 const timerScreen = document.getElementById('timer-fullscreen');
                 timerScreen.classList.add('opacity-0');
                 setTimeout(() => timerScreen.classList.add('hidden'), 500);
            },
            updateFullscreenDisplay() {
                const formatTime = (seconds) => {
                    if (seconds < 0) seconds = 0;
                    const m = Math.floor(seconds / 60); const s = seconds % 60;
                    return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                };
                document.getElementById('timer-fullscreen-display').textContent = formatTime(this.remaining);
            }
        };
        
        // --- UI MANAGER --- //
        const UI = {
            currentDetailTaskId: null,
            taskToDeleteId: null,

            openModal(modalId) {
                if (!FirebaseService.userId && modalId !== 'settingsModal') {
                    UI.showNotification("Please sign in to manage your tasks.", "error");
                    return;
                }
                const modal = document.getElementById(modalId);
                if (!modal) { console.error("Modal not found:", modalId); return; }
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            },
            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (!modal) return;
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => modal.classList.add('pointer-events-none'), 300);
            },
            toggleCompletedPanel() {
                const overlay = document.getElementById('completedOverlay');
                if (!overlay) return;
                if (overlay.classList.contains('pointer-events-none')) {
                    this.openCompletedPanel();
                } else {
                    this.closeCompletedPanel();
                }
            },
            openCompletedPanel() {
                if (!FirebaseService.userId) {
                    UI.showNotification("Please sign in to view completed tasks.", "error");
                    return;
                }
                const overlay = document.getElementById('completedOverlay');
                const panel = document.getElementById('completedPanel');
                if (!overlay || !panel) return;
                overlay.classList.remove('pointer-events-none');
                requestAnimationFrame(() => {
                    overlay.classList.remove('opacity-0');
                    panel.classList.remove('translate-x-full');
                });
            },
            closeCompletedPanel() {
                const overlay = document.getElementById('completedOverlay');
                const panel = document.getElementById('completedPanel');
                if (!overlay || !panel) return;
                panel.classList.add('translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('pointer-events-none'), 300);
            },
            openDetailsModal(taskId, evt = null) {
                if (evt) evt.stopPropagation();
                if (!FirebaseService.userId) {
                    UI.showNotification("Please sign in to view details.", "error");
                    return;
                }
                this.currentDetailTaskId = taskId;
                const task = TaskManager.tasks.find(t => t.id === taskId);
                if (!task) return;

                document.getElementById('detailsTitle').textContent = task.title;
                document.getElementById('detailTitleInput').value = task.title;
                document.getElementById('detailQuadrantSelect').value = task.quadrant;
                document.getElementById('detailTimeInput').value = task.timeBox;
                document.getElementById('detailDueDateInput').value = task.dueDate ? new Date(task.dueDate).toISOString().split('T')[0] : '';
                document.getElementById('detailCompletedCheckbox').checked = Boolean(task.completed);
                document.getElementById('taskNotes').value = task.notes || '';
                
                const subtasksContainer = document.getElementById('subtasksContainer');
                subtasksContainer.innerHTML = (task.subtasks || []).map(st => `
                    <div class="flex items-center gap-2 p-2 bg-gray-100 rounded-md">
                        <input type="checkbox" ${st.completed ? 'checked' : ''} data-action="toggle-subtask" data-subtask-id="${st.id}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                        <span class="flex-grow ${st.completed ? 'line-through text-gray-500' : 'text-gray-800'}">${escapeHtml(st.text)}</span>
                        <button data-action="delete-subtask" data-subtask-id="${st.id}" class="text-xs text-red-500 hover:text-red-700">Delete</button>
                    </div>
                `).join('') || '<p class="text-sm text-center text-gray-500">No sub-tasks yet.</p>';
                
                this.openModal('detailsModal');
                
                const notesArea = document.getElementById('taskNotes');
                notesArea.onblur = null; 
                notesArea.onblur = () => TaskManager.updateNotes(notesArea.value);
            },
            closeDetailsModal() {
                this.currentDetailTaskId = null;
                this.closeModal('detailsModal');
            },
            openDeleteModal(taskId, evt = null) {
                if (evt) evt.stopPropagation();
                if (!FirebaseService.userId) {
                    UI.showNotification("Please sign in to delete tasks.", "error");
                    return;
                }
                this.taskToDeleteId = taskId;
                this.openModal('deleteModal');
            },
            closeDeleteModal() {
                this.taskToDeleteId = null;
                this.closeModal('deleteModal');
            },
            openSettingsModal() {
                document.getElementById('geminiApiKeyInput').value = GEMINI_API_KEY;
                // Settings modal is the only one accessible when logged out
                const modal = document.getElementById('settingsModal');
                if (!modal) { console.error("Modal not found: settingsModal"); return; }
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            },
            showNotification(message, type = 'info') {
                 const container = document.getElementById('toast-container');
                 const toast = document.createElement('div');
                 let icon = '‚ÑπÔ∏è';
                 let typeClass = 'toast-info';
                 if (type === 'success') { icon = '‚úÖ'; typeClass = 'toast-success'; }
                 else if (type === 'error') { icon = '‚ùå'; typeClass = 'toast-error'; }
                 toast.className = `toast ${typeClass}`;
                 toast.innerHTML = `<span class="toast-icon">${icon}</span><span class="flex-1">${message}</span>`;
                 container.appendChild(toast);
                 setTimeout(() => { toast.remove(); }, 5000);
            },
            renderCompletedTasks(tasks) {
                const container = document.getElementById('completedTasksList');
                if (container) {
                    if (!tasks || tasks.length === 0) {
                        container.innerHTML = '<p class="p-4 text-sm text-center text-gray-500">No completed tasks yet.</p>';
                    } else {
                        const sorted = tasks.slice().sort((a, b) => {
                            const dateA = new Date(a.completedAt || a.createdAt || 0);
                            const dateB = new Date(b.completedAt || b.createdAt || 0);
                            return dateB - dateA;
                        });
                        container.innerHTML = sorted.map(task => {
                            const completedDate = task.completedAt ? new Date(task.completedAt).toLocaleString() : '';
                            const dueDate = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : '';
                            return `
                                <div class="border border-gray-200 rounded-lg shadow-sm">
                                    <div class="flex items-start justify-between gap-3 p-3">
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-semibold text-gray-700 line-through">${escapeHtml(task.title)}</p>
                                            <div class="flex flex-wrap gap-2 mt-2 text-xs text-gray-500">
                                                ${dueDate ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 bg-gray-100 rounded-full">üìÖ ${dueDate}</span>` : ''}
                                                ${completedDate ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 bg-green-100 text-green-700 rounded-full">‚úÖ ${completedDate}</span>` : ''}
                                            </div>
                                        </div>
                                        <button data-action="reopen-task" data-task-id="${task.id}" class="px-3 py-1 text-xs font-semibold text-white transition bg-blue-600 rounded-full hover:bg-blue-700">‚Ü©Ô∏è Reopen</button>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }

                const badge = document.getElementById('completedCountBadge');
                if (badge) {
                    const count = tasks?.length || 0;
                    badge.textContent = count;
                    if (count > 0) { badge.classList.remove('hidden'); }
                    else { badge.classList.add('hidden'); }
                }
            },
            showConfigWarning(message) {
                const warningDiv = document.getElementById('configWarning');
                if (warningDiv) {
                    warningDiv.innerHTML = message;
                    warningDiv.classList.remove('hidden');
                }
            }
        };
        
        // --- TASK MANAGER --- //
        const TaskManager = {
            tasks: [], 
            editingTaskId: null,

            init(userId) {
                // Now called by onAuthReady
                FirebaseService.getTasksSnapshot(this.onTasksUpdated.bind(this));
            },
            onTasksUpdated(tasks) {
                this.tasks = tasks;
                this.checkOverdueTasks(false);
                this.render();
            },
            // --- NEW: Clear tasks on sign-out ---
            clearTasks() {
                this.tasks = [];
                UI.renderCompletedTasks([]);
                UI.closeCompletedPanel();
                this.render();
            },
            addTask(event) {
                event.preventDefault();
                const title = document.getElementById('taskTitle').value.trim();
                const dueDateValue = document.getElementById('taskDueDate').value;
                if (!title) return;
                const task = {
                    title,
                    timeBox: parseInt(document.getElementById('taskTime').value) || 25,
                    quadrant: parseInt(document.getElementById('taskQuadrant').value),
                    completed: false,
                    completedAt: null,
                    createdAt: new Date().toISOString(),
                    dueDate: dueDateValue ? new Date(dueDateValue + 'T00:00:00').toISOString() : null,
                    subtasks: [],
                    notes: '',
                    remainingTime: null
                };
                FirebaseService.addTask(task);
                UI.showNotification("Task added!", "success");
                event.target.reset();
                UI.closeModal('addTaskModal');
            },
            updateTask(task) {
                const { id, ...taskData } = task;
                FirebaseService.updateTask(id, taskData);
            },
            editTask(taskId, evt = null) {
                if (evt) evt.stopPropagation();
                this.editingTaskId = taskId;
                this.render();
                if (taskId === null) { return; }
                const input = document.querySelector(`.task-title-input[data-task-id='${taskId}']`);
                if (input) { input.focus(); input.select(); }
            },
            saveTaskTitle(taskId, newTitle) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task && newTitle.trim()) {
                    task.title = newTitle.trim();
                    this.updateTask(task);
                }
                this.editingTaskId = null;
            },
            confirmDelete() {
                if (UI.taskToDeleteId) {
                    FirebaseService.deleteTask(UI.taskToDeleteId);
                    UI.showNotification("Task deleted.", "success");
                }
                UI.closeDeleteModal();
            },
            toggleComplete(taskId, evt = null) {
                if (evt) evt.stopPropagation();
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    const newStatus = !task.completed;
                    task.completed = newStatus;
                    task.completedAt = newStatus ? new Date().toISOString() : null;
                    this.updateTask(task);
                }
            },
            addSubtask(text, fromAI = false) {
                const taskId = UI.currentDetailTaskId;
                const task = this.tasks.find(t => t.id === taskId);
                let subtaskText = text;
                if (!fromAI) {
                    const input = document.getElementById('newSubtaskInput');
                    subtaskText = input.value.trim();
                }
                if (!task || !subtaskText) return;
                if (!task.subtasks) task.subtasks = [];
                const subtaskId = task.subtasks.length > 0 ? Math.max(...task.subtasks.map(s => s.id)) + 1 : 1;
                task.subtasks.push({ id: subtaskId, text: subtaskText, completed: false });
                if (!fromAI) { document.getElementById('newSubtaskInput').value = ''; }
                this.updateTask(task); 
                UI.openDetailsModal(taskId, null);
            },
            toggleSubtask(subtaskId) {
                const taskId = UI.currentDetailTaskId;
                const task = this.tasks.find(t => t.id === taskId);
                if (!task) return;
                const subtask = task.subtasks.find(st => st.id === subtaskId);
                if(subtask) subtask.completed = !subtask.completed;
                this.updateTask(task);
                UI.openDetailsModal(taskId, null);
            },
            deleteSubtask(subtaskId) {
                const taskId = UI.currentDetailTaskId;
                const task = this.tasks.find(t => t.id === taskId);
                if (!task) return;
                task.subtasks = task.subtasks.filter(st => st.id !== subtaskId);
                this.updateTask(task);
                UI.openDetailsModal(taskId, null);
            },
            updateNotes(notes) {
                const taskId = UI.currentDetailTaskId;
                const task = this.tasks.find(t => t.id === taskId);
                if (task) { task.notes = notes; this.updateTask(task); }
            },
            saveDetails() {
                const taskId = UI.currentDetailTaskId;
                const task = this.tasks.find(t => t.id === taskId);
                if (!task) { return; }

                const titleInput = document.getElementById('detailTitleInput');
                const quadrantSelect = document.getElementById('detailQuadrantSelect');
                const timeInput = document.getElementById('detailTimeInput');
                const dueDateInput = document.getElementById('detailDueDateInput');
                const completedCheckbox = document.getElementById('detailCompletedCheckbox');
                const wasCompleted = task.completed;

                if (titleInput && titleInput.value.trim()) { task.title = titleInput.value.trim(); }
                task.quadrant = parseInt(quadrantSelect.value, 10);
                const newTimeBox = parseInt(timeInput.value, 10) || 25;
                if (task.timeBox !== newTimeBox) { task.remainingTime = null; }
                task.timeBox = newTimeBox;
                const dueDateValue = dueDateInput.value;
                task.dueDate = dueDateValue ? new Date(dueDateValue + 'T00:00:00').toISOString() : null;
                task.completed = completedCheckbox.checked;
                if (task.completed && !wasCompleted) {
                    task.completedAt = new Date().toISOString();
                } else if (!task.completed) {
                    task.completedAt = null;
                }
                this.updateTask(task);
                UI.showNotification('Task details updated.', 'success');
            },
            moveTask(taskId, newQuadrant) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) { task.quadrant = newQuadrant; this.updateTask(task); }
            },
            dragStart(event, taskId) { 
                if (!FirebaseService.userId) { event.preventDefault(); return; }
                event.stopPropagation(); 
                event.dataTransfer.setData('text/plain', taskId);
                event.currentTarget.classList.add('dragging');
            },
            dragEnd(event) { event.currentTarget.classList.remove('dragging'); },
            allowDrop(event) { 
                if (!FirebaseService.userId) return;
                event.preventDefault(); 
                event.currentTarget.classList.add('drag-over'); 
            },
            dragLeave(event) { event.currentTarget.classList.remove('drag-over'); },
            drop(event) {
                if (!FirebaseService.userId) return;
                event.preventDefault(); 
                event.currentTarget.classList.remove('drag-over');
                const taskId = event.dataTransfer.getData('text/plain');
                const newQuadrant = parseInt(event.currentTarget.dataset.quadrant);
                this.moveTask(taskId, newQuadrant);
            },
            checkOverdueTasks(save = true) {
                const now = new Date();
                const soonThreshold = new Date(now.getTime() + (2 * 24 * 60 * 60 * 1000));
                let movedToUrgentImportant = false;
                let movedToImportant = false;

                this.tasks.forEach(task => {
                    if (!task.dueDate || task.completed) { return; }

                    const dueDate = new Date(task.dueDate);

                    if (dueDate < now) {
                        if (task.quadrant !== 1) {
                            task.quadrant = 1;
                            if (save) { this.updateTask(task); }
                            movedToUrgentImportant = true;
                        }
                        return;
                    }

                    if (dueDate <= soonThreshold && task.quadrant !== 1 && task.quadrant !== 2) {
                        task.quadrant = 2;
                        if (save) { this.updateTask(task); }
                        movedToImportant = true;
                    }
                });

                if (save) {
                    if (movedToImportant) {
                        UI.showNotification("Tasks due within two days were moved to 'Important'.", "info");
                    }
                    if (movedToUrgentImportant) {
                        UI.showNotification("Overdue tasks were moved to 'Urgent & Important'.", "info");
                    }
                }
            },
            render() {
                if (Timer.isRunning) return;

                // Show a message if logged out
                if (!FirebaseService.userId) {
                    for (let i = 1; i <= 4; i++) {
                        document.getElementById(`count-${i}`).textContent = 0;
                        document.getElementById(`tasks-${i}`).innerHTML = `<div class="p-4 text-center text-gray-500">Please sign in to see your tasks.</div>`;
                    }
                    UI.renderCompletedTasks([]);
                    UI.closeCompletedPanel();
                    return;
                }

                const completedTasks = this.tasks.filter(t => t.completed);

                for (let i = 1; i <= 4; i++) {
                    const container = document.getElementById(`tasks-${i}`);
                    let quadrantTasks = this.tasks
                        .filter(t => t.quadrant === i && !t.completed)
                        .slice()
                        .sort((a, b) => {
                            const hasDueA = !!a.dueDate;
                            const hasDueB = !!b.dueDate;

                            if (hasDueA && hasDueB) {
                                const diff = new Date(a.dueDate) - new Date(b.dueDate);
                                if (diff !== 0) { return diff; }
                            } else if (hasDueA || hasDueB) {
                                return hasDueA ? -1 : 1;
                            }

                            const durationDiff = (b.timeBox || 0) - (a.timeBox || 0);
                            if (durationDiff !== 0) { return durationDiff; }

                            return new Date(a.createdAt || 0) - new Date(b.createdAt || 0);
                        });
                    document.getElementById(`count-${i}`).textContent = quadrantTasks.length;
                    
                    if (quadrantTasks.length === 0) { 
                        container.innerHTML = `<div class="p-4 text-center text-gray-500">No tasks here.</div>`; 
                        continue; 
                    }
                    
                    container.innerHTML = quadrantTasks.map(task => {
                        const isRunning = Timer.currentTask && Timer.currentTask.id === task.id;
                        const isOverdue = task.dueDate && !task.completed && new Date(task.dueDate) < new Date();
                        
                        const titleDisplay = this.editingTaskId === task.id
                            ? `<input type="text" class="task-title-input" data-task-id="${task.id}" value="${escapeHtml(task.title)}">`
                            : `<p class="font-semibold text-gray-800 truncate task-title-text" data-action="edit-title">${escapeHtml(task.title)}</p>`;
                        
                        let timeDisplay = `${task.timeBox}m`;
                        if (task.remainingTime && task.remainingTime > 0 && task.remainingTime < task.timeBox * 60) {
                            timeDisplay = `~${Math.ceil(task.remainingTime / 60)}m left`;
                        }

                        return `
                        <div class="task flex items-center justify-between p-3 transition duration-200 ease-in-out bg-white border-l-4 rounded-lg shadow-sm ${task.completed ? 'completed' : ''} ${isRunning ? 'running' : ''} ${isOverdue ? 'overdue' : ''} quadrant-${task.quadrant}-border" 
                             data-task-id="${task.id}" draggable="true" data-action="drag-start">
                            <div class="flex-1 min-w-0 task-title cursor-pointer" data-action="open-details">
                               ${titleDisplay}
                               <div class="flex items-center gap-3 mt-1 text-xs text-gray-500 task-meta">
                                    ${task.dueDate ? `<span>üìÖ ${new Date(task.dueDate).toLocaleDateString()}</span>` : ''}
                                    <span>‚è±Ô∏è ${timeDisplay}</span>
                               </div>
                            </div>
                            <div class="flex items-center gap-1 ml-2 task-actions">
                                 <button title="Start Timer" data-action="start-timer" class="p-1 text-gray-400 rounded-full task-btn hover:bg-gray-200 hover:text-yellow-500">‚è±Ô∏è</button>
                                <button title="Mark as ${task.completed ? 'Incomplete' : 'Complete'}" data-action="toggle-complete" class="p-1 text-gray-400 rounded-full task-btn hover:bg-gray-200">${task.completed ? '‚Ü©Ô∏è' : '‚úÖ'}</button>
                                <button title="Delete Task" data-action="open-delete-modal" class="p-1 text-gray-400 rounded-full task-btn hover:bg-gray-200 hover:text-red-500">üóëÔ∏è</button>
                            </div>
                        </div>
                    `}).join('');
                }

                UI.renderCompletedTasks(completedTasks);
            },
        };

        // --- APP INITIALIZER --- //
        const App = {
            init() {
                GeminiService.init();
                // --- UPDATED INIT CALL ---
                FirebaseService.init(
                    this.onAuthReady, // Function to run on sign-in
                    this.onSignedOut  // Function to run on sign-out
                );
                // --- END UPDATED INIT CALL ---
                this.bindDirectListeners();
                this.bindDelegatedListeners();
            },
            onAuthReady(userId) {
                TaskManager.init(userId);
            },
            // --- NEW: Handle sign-out ---
            onSignedOut() {
                TaskManager.clearTasks();
            },
            // --- END NEW ---
            bindDirectListeners() {
                document.getElementById('addTaskForm').addEventListener('submit', (e) => TaskManager.addTask(e));
                document.getElementById('timer-fullscreen-pause').addEventListener('click', () => Timer.pause());
                document.getElementById('timer-fullscreen-start').addEventListener('click', () => Timer.start());
                document.getElementById('timer-fullscreen-stop').addEventListener('click', () => Timer.stop());

                document.querySelectorAll('.quadrant').forEach(quadrant => {
                    quadrant.addEventListener('dragover', TaskManager.allowDrop);
                    quadrant.addEventListener('dragleave', TaskManager.dragLeave);
                    quadrant.addEventListener('drop', TaskManager.drop);
                });
                
                document.getElementById('detailsModal').addEventListener('keydown', (e) => {
                    if (e.target.id === 'newSubtaskInput' && e.key === 'Enter') {
                        TaskManager.addSubtask(null, false);
                    }
                });
            },
            bindDelegatedListeners() {
                document.body.addEventListener('click', (e) => {
                    const actionTarget = e.target.closest('[data-action]');
                    if (!actionTarget) return;

                    const action = actionTarget.dataset.action;
                    const taskTarget = e.target.closest('.task');
                    const taskId = actionTarget.dataset.taskId || taskTarget?.dataset.taskId;

                    switch (action) {
                        // --- NEW AUTH ACTIONS ---
                        case 'sign-in-google': FirebaseService.signInWithGoogle(); break;
                        case 'sign-out': FirebaseService.signOut(); break;
                        // --- END NEW AUTH ACTIONS ---

                        case 'open-settings': UI.openSettingsModal(); break;
                        case 'toggle-completed-panel': UI.toggleCompletedPanel(); break;
                        case 'close-completed-panel': UI.closeCompletedPanel(); break;
                        case 'open-add-modal': UI.openModal('addTaskModal'); break;
                        case 'open-details': UI.openDetailsModal(taskId, e); break;
                        case 'edit-title': TaskManager.editTask(taskId, e); break;
                        case 'start-timer': Timer.startFromTask(taskId, e); break;
                        case 'toggle-complete': TaskManager.toggleComplete(taskId, e); break;
                        case 'reopen-task': TaskManager.toggleComplete(taskId, e); break;
                        case 'open-delete-modal': UI.openDeleteModal(taskId, e); break;
                        case 'close-modal': UI.closeModal(e.target.closest('.modal').id); break;
                        case 'save-api-key': GeminiService.saveApiKey(); break;
                        case 'confirm-delete': TaskManager.confirmDelete(); break;
                        case 'save-details': TaskManager.saveDetails(); break;
                        case 'gen-subtasks': GeminiService.generateSubtasks(); break;
                        case 'gen-notes': GeminiService.generateNotes(); break;
                        case 'add-subtask': TaskManager.addSubtask(null, false); break;
                        case 'toggle-subtask': TaskManager.toggleSubtask(Number(actionTarget.dataset.subtaskId)); break;
                        case 'delete-subtask': TaskManager.deleteSubtask(Number(actionTarget.dataset.subtaskId)); break;
                    }
                });
                
                const mainContent = document.getElementById('main-content');
                
                mainContent.addEventListener('focusout', (e) => {
                    if (e.target.classList.contains('task-title-input')) {
                        TaskManager.saveTaskTitle(e.target.dataset.taskId, e.target.value);
                    }
                });
                mainContent.addEventListener('keydown', (e) => {
                    if (e.target.classList.contains('task-title-input')) {
                        if (e.key === 'Enter') e.target.blur();
                        if (e.key === 'Escape') TaskManager.editTask(null, e);
                    }
                });
                
                document.body.addEventListener('dragstart', (e) => {
                    const dragTarget = e.target.closest('[data-action="drag-start"]');
                    if (dragTarget) {
                        const taskId = dragTarget.closest('.task')?.dataset.taskId;
                        TaskManager.dragStart(e, taskId);
                    }
                });
                document.body.addEventListener('dragend', (e) => {
                     if (e.target.classList.contains('task')) { TaskManager.dragEnd(e); }
                });
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>


